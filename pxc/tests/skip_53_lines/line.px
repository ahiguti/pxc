namespace line;
import common -;
import io::file -;
import io::buffered -;
import string::conversion -;

function {t} void split_into_struct(cslice{uchar} const& toks, uchar delim,
  t& value_r)
{
}

function void t1()
{
  string buffer;
  var msg = "x";
  var eh = io::errno::errno_handler(error::handle_keep);
  var f = system.open("hoge2.txt", io::file::O_RDONLY, 0, eh);
  stream_foreach{file, parse_line}(f, buffer, '\n', 4096, eh);
  function void parse_line(cslice{uchar} const& line) {
    string s = "cb ";
    s.append(msg); // upvalue
    s.append(" len=");
    s.append(to_string(line.size()));
    s.append(" [");
    s.append(line);
    s.append("]");
    println(s);
  }
}

t1();

