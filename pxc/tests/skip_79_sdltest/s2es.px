namespace s2es;
import common -;
import SDL2 -;
import GL::gl11 -;

function void draw_tri()
{
  const v = make_farray{float}(
    0.0, static_cast{float}(-1.732 / 3.0 * 2.0),
    -1.0, static_cast{float}(1.732 / 3.0),
    1.0, static_cast{float}(1.732 / 3.0));
  const sv = v[0 .. v.size()];
  glEnableClientState(GL_VERTEX_ARRAY);
  glVertexPointer(2, GL_FLOAT, 0, sv.crawptr().void());
  glDrawArrays(GL_TRIANGLES, 0, 3);
  glDisableClientState(GL_VERTEX_ARRAY);
  /*
  glBegin(GL_TRIANGLES);
  glVertex2f(0.0, static_cast{float}(-1.732 / 3.0 * 2.0));
  glVertex2f(-1.0, static_cast{float}(1.732 / 3.0));
  glVertex2f(1.0, static_cast{float}(1.732 / 3.0));
  glEnd();
  */
}

function void compat_glFrustum(double left, double right, double bottom, 
  double top, double near, double far)
{
  farray{float, 16} a;
  a[0]  = static_cast{float}(near * 2.0 / (right - left));
  a[5]  = static_cast{float}(near * 2.0 / (top - bottom));
  a[8]  = static_cast{float}((right + left) / (right - left));
  a[9]  = static_cast{float}((top + bottom) / (top - bottom));
  a[10] = static_cast{float}(-(far + near) / (far - near));
  a[11] = static_cast{float}(-1.0);
  a[14] = static_cast{float}(-(far * near * 2.0) / (far - near));
  glMultMatrixf(a.crawptr());
}

{
  const sdl = SDL2::SDL(system, SDL_INIT_VIDEO);
  const wnd = sdl.CreateWindow("s2", 0, 0, 640, 480,
    SDL_WINDOW_OPENGL | SDL_WINDOW_RESIZABLE).some;
  const glctx = sdl.GL_CreateContext(wnd);
  bool done = false;
  float theta;
  float xinc;
  {
    glMatrixMode(GL_PROJECTION);
    glLoadIdentity();
    // glFrustum(-1.0, 1.0, -1.0, 1.0, 5.0, 100.0);
    compat_glFrustum(-1.0, 1.0, -1.0, 1.0, 5.0, 100.0);
    glMatrixMode(GL_MODELVIEW);
  }
  while (!done) {
    Event ev;
    while (sdl.PollEvent(ev)) {
      if (ev.type == SDL_QUIT) {
	done = true;
	break;
      }
    }
    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
    glPushMatrix();
    glTranslatef(0.0, 2.0, -10.0);
    glRotatef(theta, 0.0, 0.0, 1.0);
    for (int i : 0 .. 100) {
      glTranslatef(0.0, 0.0, -1.0);
      draw_tri();
    }
    glPopMatrix();
    system.usleep(10000);
    sdl.GL_SwapWindow(wnd);
    theta += 1.0;
    xinc += 1.00000;
  }
}

